<!DOCTYPE html>
<html lang="kk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Details Lookup</title>
  <style>
    :root {
      --main-color: #FBE338;
      --text-color: #000000;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--main-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
      margin: 0;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      box-sizing: border-box;
    }
    h2 {
      margin-top: 0;
      text-align: center;
      color: var(--text-color);
    }
    .lang-switch {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 10px;
      gap: 8px;
    }
    .lang-btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
    }
    .lang-btn.active {
      background: var(--main-color);
      border-color: var(--main-color);
      font-weight: bold;
    }
    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
      color: var(--text-color);
    }
    input[type="password"] {
      letter-spacing: 2px;
    }
    button {
      background: var(--main-color);
      color: var(--text-color);
      cursor: pointer;
      font-weight: 600;
      border: none;
    }
    button:hover {
      opacity: 0.9;
    }
    label {
      font-size: 14px;
      display: block;
      margin-top: 8px;
      color: var(--text-color);
    }
    .balance {
      margin-top: 10px;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-color);
    }
    .balance span {
      font-weight: 700;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 14px;
      color: var(--text-color);
    }
    th {
      background: var(--main-color);
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="lang-switch">
      <button class="lang-btn active" id="btnKz" onclick="setLanguage('kz')">Қаз</button>
      <button class="lang-btn" id="btnRu" onclick="setLanguage('ru')">Рус</button>
    </div>

    <h2 id="titleText">Карта деректерін қарау</h2>

    <input type="text" id="cardNumber" placeholder="Картаның нөмірін енгізіңіз" />
    <input type="password" id="pin" placeholder="PIN код" maxlength="10" />

    <!-- Date section (hidden until PIN is entered) -->
    <div id="dateSection" class="hidden">
      <label id="labelFrom" for="fromDate">Күні (бастап):</label>
      <input type="date" id="fromDate" onkeydown="return false" />
      <label id="labelTo" for="toDate">Күні (дейін):</label>
      <input type="date" id="toDate" onkeydown="return false" />
    </div>

    <button id="btnGetDetails" onclick="fetchData()">Деректерді алу</button>

    <div class="balance">
      <span id="balanceLabel">Баланc:</span>
      <span id="balanceValue">—</span>
    </div>

    <table id="resultsTable" class="hidden">
      <thead>
        <tr>
          <th id="thPhone">Телефон</th>
          <th id="thCallTime">Қоңырау уақыты</th>
          <th id="thDuration">Ұзақтығы (с)</th>
          <th id="thCost">Құны</th>
        </tr>
      </thead>
      <tbody id="resultsBody"></tbody>
    </table>
  </div>

  <script>
    let currentLang = 'kz';

    const translations = {
      kz: {
        title: 'Бастау картасының деректерін қарау',
        cardPlaceholder: 'Картаның нөмірін енгізіңіз',
        pinPlaceholder: 'PIN код',
        fromDate: 'Күні (бастап):',
        toDate: 'Күні (дейін):',
        button: 'Деректерді алу',
        balanceLabel: 'Баланc:',
        noRecords: 'Жазбалар табылмады',
        phone: 'Телефон',
        callTime: 'Қоңырау уақыты',
        duration: 'Ұзақтығы (с)',
        cost: 'Құны',
        enterCard: 'Карта нөмірін енгізіңіз',
        fillDates: 'Күндерді таңдаңыз',
        errorGeneric: 'Деректерді алу кезінде қате пайда болды.',
        loading: 'Жүктелуде...'
      },
      ru: {
        title: 'Просмотр данных по карте Бастау',
        cardPlaceholder: 'Введите номер карты',
        pinPlaceholder: 'PIN код',
        fromDate: 'Дата (с):',
        toDate: 'Дата (по):',
        button: 'Получить данные',
        balanceLabel: 'Баланс:',
        noRecords: 'Записей не найдено',
        phone: 'Телефон',
        callTime: 'Время звонка',
        duration: 'Длительность (с)',
        cost: 'Стоимость',
        enterCard: 'Введите номер карты',
        fillDates: 'Выберите даты',
        errorGeneric: 'Произошла ошибка при получении данных.',
        loading: 'Загрузка...'
      }
    };

    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.documentElement.lang = (lang === 'kz') ? 'kk' : 'ru';

      document.getElementById('titleText').textContent = t.title;
      document.getElementById('cardNumber').placeholder = t.cardPlaceholder;
      document.getElementById('pin').placeholder = t.pinPlaceholder;
      document.getElementById('labelFrom').textContent = t.fromDate;
      document.getElementById('labelTo').textContent = t.toDate;
      document.getElementById('btnGetDetails').textContent = t.button;
      document.getElementById('balanceLabel').textContent = t.balanceLabel;
      document.getElementById('thPhone').textContent = t.phone;
      document.getElementById('thCallTime').textContent = t.callTime;
      document.getElementById('thDuration').textContent = t.duration;
      document.getElementById('thCost').textContent = t.cost;

      document.getElementById('btnKz').classList.toggle('active', lang === 'kz');
      document.getElementById('btnRu').classList.toggle('active', lang === 'ru');
    }

    function setDefaultDates() {
      const fromInput = document.getElementById('fromDate');
      const toInput = document.getElementById('toDate');

      const today = new Date();
      const sevenAgo = new Date();
      sevenAgo.setDate(today.getDate() - 7);

      const formatDate = d =>
        `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

      if (!toInput.value) toInput.value = formatDate(today);
      if (!fromInput.value) fromInput.value = formatDate(sevenAgo);
    }

    async function fetchData() {
      const cardNumber = document.getElementById('cardNumber').value.trim();
      const pin = document.getElementById('pin').value.trim();
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const balanceSpan = document.getElementById('balanceValue');
      const tbody = document.getElementById('resultsBody');
      const table = document.getElementById('resultsTable');
      const t = translations[currentLang];

      if (!cardNumber) {
        alert(t.enterCard);
        return;
      }

      const btn = document.getElementById('btnGetDetails');
      const originalBtnText = t.button;
      btn.textContent = t.loading;
      btn.disabled = true;

      try {
        // Always fetch balance
        const balanceUrl = `https://www.lun.kz/api/card/balance?number=${cardNumber}`;

        // If PIN is empty → only balance
        if (!pin) {
          const balanceRes = await fetch(balanceUrl);
          if (!balanceRes.ok) throw new Error('Balance error');
          const balanceJson = await balanceRes.json();
          balanceSpan.textContent = balanceJson.balance ?? '0.00';

          // Hide table (no detalization)
          table.classList.add('hidden');
          tbody.innerHTML = '';
        } else {
          // PIN is present → require dates + fetch detalization + balance
          if (!fromDate || !toDate) {
            alert(t.fillDates);
            return;
          }

          const detailsUrl =
            `https://www.lun.kz/api/card/details?number=${cardNumber}&date_from=${fromDate}&date_to=${toDate}&pin=${pin}&page=1`;

          const [detailsRes, balanceRes] = await Promise.all([
            fetch(detailsUrl),
            fetch(balanceUrl)
          ]);

          if (!detailsRes.ok || !balanceRes.ok) throw new Error('API error');

          const detailsJson = await detailsRes.json();
          const balanceJson = await balanceRes.json();

          balanceSpan.textContent = balanceJson.balance ?? '0.00';

          const data = detailsJson.data || [];
          tbody.innerHTML = '';

          if (data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4">${t.noRecords}</td></tr>`;
          } else {
            data.forEach(item => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${item.phone}</td>
                <td>${item.call_time}</td>
                <td>${item.duration}</td>
                <td>${item.cost}</td>
              `;
              tbody.appendChild(row);
            });
          }

          table.classList.remove('hidden');
        }
      } catch (error) {
        alert(t.errorGeneric);
        console.error(error);
      } finally {
        btn.textContent = originalBtnText;
        btn.disabled = false;
      }
    }

    function setupPinBehavior() {
      const pinInput = document.getElementById('pin');
      const dateSection = document.getElementById('dateSection');
      const table = document.getElementById('resultsTable');
      const tbody = document.getElementById('resultsBody');

      pinInput.addEventListener('input', () => {
        const hasPin = pinInput.value.trim().length > 0;
        if (hasPin) {
          dateSection.classList.remove('hidden');
          setDefaultDates();
        } else {
          dateSection.classList.add('hidden');
          // Hide detalization table if PIN cleared
          table.classList.add('hidden');
          tbody.innerHTML = '';
        }
      });
    }

    // Init
    setLanguage('kz');
    setupPinBehavior();
  </script>
</body>
</html>

